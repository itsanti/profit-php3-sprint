<?php
# объекты и классы в PHP
# https://habrahabr.ru/company/mailru/blog/255237/

class Leak
{
	public $value;
	public $self;
}

for ($i = 0; $i < 1000000; $i++) {
	if ($i % 500 == 0) {
		echo $i, "\t", memory_get_usage(), "\n";
	}
	$obj = new Leak(); # $obj --> Leak
	$obj->value = rand();
	$obj->self = $obj; # $obj->self --> Leak
	unset($obj);
}
echo "end\t", memory_get_usage(), "\n";

/** PHP 5.6
 * видно, что через каждые 10000 итераций (ёмкость root buffer)
 * память освобождается.
0       224776   \  100000  1207992
500     312816   \  100500  1295992
1000    400816   \  101000  1385912
1500    554352   \  101500  1475368
2000    642352   \  102000  1563384
2500    861424   \  102500  1651400
3000    949440   \  103000  1739400
3500    1037440  \  103500  1827400
4000    1125456  \  104000  1915400
4500    1475600  \  104500  2003416
5000    1563600  \  105000  2091416
5500    1651600  \  105500  2179416
6000    1739600  \  106000  2267416
6500    1827600  \  106500  2355416
7000    1915600  \  107000  2443416
7500    2003600  \  107500  2531416
8000    2091600  \  108000  2619416
8500    2703904  \  108500  2707416
9000    2791904  \  109000  2795416
9500    2879904  \  109500  2883416
10000   1207992  \  110000  1207992
*/

/** PHP 7.0
 * видно, что через каждые 10000 итераций память освобождается.
 * какое-то количество памяти успевает утекать, но гораздо меньшее.
 * https://habrahabr.ru/company/mailru/blog/257999/
0       351432   \   100000  474392
500     391432   \   100500  514392
1000    431432   \   101000  554392
1500    479624   \   101500  594392
2000    519624   \   102000  634392
2500    576008   \   102500  674392
3000    616008   \   103000  714392
3500    656008   \   103500  754392
4000    696008   \   104000  794392
4500    768776   \   104500  834392
5000    808776   \   105000  874392
5500    848776   \   105500  914392
6000    888776   \   106000  954392
6500    928776   \   106500  994392
7000    968776   \   107000  1034392
7500    1008776  \   107500  1074392
8000    1048776  \   108000  1114392
8500    1154312  \   108500  1154392
9000    1194312  \   109000  1194392
9500    1234312  \   109500  1234392
10000   474392   \   110000  474392
 */







